<app-navbar></app-navbar>

<div class="stage-list-layout" (keydown)="onKeyDown($event)">
  <div class="stage-list-container">
    
    <!-- Header Section -->
    <div class="page-header animate-fadeIn">
      <div class="header-content">
        <div class="header-text">
          <h1>
            <i class="bi bi-briefcase-fill"></i>
            Mes Stages
          </h1>
          <p>Historique complet de vos demandes de stage et leur progression</p>
        </div>
        <div class="header-actions">
          <a routerLink="/student/new-stage" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i>
            <span>Nouveau Stage</span>
          </a>
          <a routerLink="/student/dashboard" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i>
            <span>Retour</span>
          </a>
        </div>
      </div>
    </div>

    <!-- Statistics Overview -->
    <div class="stats-overview animate-slideInLeft">
      <div class="stats-grid">
        <div class="stat-card stat-primary">
          <div class="stat-icon">
            <i class="bi bi-file-earmark-plus"></i>
          </div>
          <div class="stat-content">
            <div class="stat-value">{{ stats.total }}</div>
            <div class="stat-label">Total</div>
            <div class="stat-progress">
              <div class="progress-bar" style="width: 100%; background: var(--primary-500)"></div>
            </div>
          </div>
        </div>

        <div class="stat-card stat-warning">
          <div class="stat-icon">
            <i class="bi bi-clock-history"></i>
          </div>
          <div class="stat-content">
            <div class="stat-value">{{ stats.enAttente }}</div>
            <div class="stat-label">En attente</div>
            <div class="stat-progress">
              <div class="progress-bar" 
                   [style.width.%]="getProgressPercentage('enAttente')"
                   style="background: var(--warning-500)"></div>
            </div>
          </div>
        </div>

        <div class="stat-card stat-success">
          <div class="stat-icon">
            <i class="bi bi-check-circle-fill"></i>
          </div>
          <div class="stat-content">
            <div class="stat-value">{{ stats.valides }}</div>
            <div class="stat-label">Validés</div>
            <div class="stat-progress">
              <div class="progress-bar" 
                   [style.width.%]="getProgressPercentage('valides')"
                   style="background: var(--success-500)"></div>
            </div>
          </div>
        </div>

        <div class="stat-card stat-info">
          <div class="stat-icon">
            <i class="bi bi-briefcase"></i>
          </div>
          <div class="stat-content">
            <div class="stat-value">{{ stats.enCours }}</div>
            <div class="stat-label">En cours</div>
            <div class="stat-progress">
              <div class="progress-bar" 
                   [style.width.%]="getProgressPercentage('enCours')"
                   style="background: var(--info-500)"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Filters and Search -->
    <app-card 
      title="Filtres et recherche"
      headerIcon="bi-funnel"
      variant="default"
      class="filters-card animate-slideInRight">
      
      <div slot="header-actions">
        <button class="btn btn-outline-secondary btn-sm" (click)="resetFilters()">
          <i class="bi bi-arrow-clockwise"></i>
          <span>Réinitialiser</span>
        </button>
      </div>

      <div class="filters-content">
        <div class="filters-grid">
          <div class="filter-group">
            <label class="filter-label">
              <i class="bi bi-search"></i>
              Rechercher
            </label>
            <input 
              type="text" 
              class="filter-input"
              placeholder="Sujet, entreprise..."
              [(ngModel)]="searchTerm"
              (input)="onSearchChange()">
          </div>

          <div class="filter-group">
            <label class="filter-label">
              <i class="bi bi-flag"></i>
              Statut
            </label>
            <select 
              class="filter-select"
              [(ngModel)]="statusFilter"
              (change)="onStatusFilterChange()">
              <option *ngFor="let option of statusOptions" [value]="option.value">
                {{ option.label }}
              </option>
            </select>
          </div>

          <div class="filter-group">
            <label class="filter-label">
              <i class="bi bi-sort-down"></i>
              Trier par
            </label>
            <div class="sort-controls">
              <select 
                class="filter-select"
                [(ngModel)]="sortBy"
                (change)="onSortChange()">
                <option value="dateCreation">Date de création</option>
                <option value="dateDebut">Date de début</option>
                <option value="entreprise">Entreprise</option>
                <option value="etat">Statut</option>
              </select>
              <button 
                class="btn btn-outline-secondary btn-sm"
                (click)="toggleSortDirection()"
                [title]="sortDirection === 'asc' ? 'Tri croissant' : 'Tri décroissant'">
                <i class="bi" [ngClass]="sortDirection === 'asc' ? 'bi-sort-up' : 'bi-sort-down'"></i>
              </button>
            </div>
          </div>

          <div class="filter-results">
            <div class="results-badge">
              <i class="bi bi-list-check"></i>
              <span>{{ filteredStages.length }} / {{ stages.length }}</span>
            </div>
          </div>
        </div>
      </div>
    </app-card>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Loading State -->
      <app-loading 
        *ngIf="loading" 
        size="lg" 
        variant="primary"
        message="Chargement de vos stages..."
        description="Récupération de votre historique de stages">
      </app-loading>

      <!-- Empty State -->
      <app-empty-state 
        *ngIf="!loading && stages.length === 0"
        title="Aucun stage trouvé"
        description="Vous n'avez pas encore créé de demande de stage. Commencez par soumettre votre première demande."
        icon="bi-briefcase"
        variant="info"
        [actions]="emptyStateActions">
      </app-empty-state>

      <!-- No Results State -->
      <app-empty-state 
        *ngIf="!loading && stages.length > 0 && filteredStages.length === 0"
        title="Aucun résultat"
        description="Aucun stage ne correspond à vos critères de recherche."
        icon="bi-search"
        variant="warning"
        [actions]="[{
          label: 'Réinitialiser les filtres',
          icon: 'bi-arrow-clockwise',
          variant: 'primary',
          action: () => resetFilters()
        }]">
      </app-empty-state>

      <!-- Stages Grid -->
      <div *ngIf="!loading && filteredStages.length > 0" class="stages-grid">
        <div *ngFor="let stage of filteredStages; trackBy: trackByStageId; let i = index" 
             class="stage-card"
             [style.animation-delay]="i * 80 + 'ms'">
          
          <!-- Stage Header -->
          <div class="stage-header">
            <div class="stage-title">
              <h4>{{ stage.sujet }}</h4>
              <div class="stage-meta">
                <span class="stage-id">#{{ stage.id }}</span>
                <span class="badge status-badge" [ngClass]="getStatusClass(stage.etat)">
                  <i class="bi" [ngClass]="getStatusIcon(stage.etat)"></i>
                  {{ getStatusText(stage.etat) }}
                </span>
              </div>
            </div>
            
            <!-- Progress Indicator -->
            <div class="stage-progress">
              <div class="progress-track">
                <div class="progress-fill" [style.width.%]="getStageProgress(stage)"></div>
              </div>
              <span class="progress-text">{{ getStageProgress(stage) }}%</span>
            </div>
          </div>

          <!-- Stage Body -->
          <div class="stage-body">
            <div class="stage-info">
              <div class="info-item">
                <div class="info-icon">
                  <i class="bi bi-building"></i>
                </div>
                <div class="info-content">
                  <label>Entreprise</label>
                  <span>{{ stage.entreprise }}</span>
                </div>
              </div>

              <div class="info-item">
                <div class="info-icon">
                  <i class="bi bi-mortarboard"></i>
                </div>
                <div class="info-content">
                  <label>Filière</label>
                  <span>{{ stage.filiere }}</span>
                </div>
              </div>

              <div class="info-item">
                <div class="info-icon">
                  <i class="bi bi-calendar-range"></i>
                </div>
                <div class="info-content">
                  <label>Période</label>
                  <span>{{ stage.dateDebut | date:'dd/MM/yyyy' }} - {{ stage.dateFin | date:'dd/MM/yyyy' }}</span>
                </div>
              </div>

              <div class="info-item" *ngIf="stage.encadrant">
                <div class="info-icon">
                  <i class="bi bi-person-badge"></i>
                </div>
                <div class="info-content">
                  <label>Encadrant</label>
                  <span>{{ stage.encadrant.prenom }} {{ stage.encadrant.nom }}</span>
                </div>
              </div>
            </div>

            <!-- Stage Note -->
            <div *ngIf="stage.note" class="stage-note">
              <div class="note-icon">
                <i class="bi bi-chat-left-text"></i>
              </div>
              <div class="note-content">
                <label>Note de l'encadrant</label>
                <p>{{ stage.note }}</p>
              </div>
            </div>

            <!-- Time Indicators -->
            <div class="time-indicators" *ngIf="stage.etat === 'EN_COURS'">
              <div class="time-indicator" 
                   [ngClass]="{
                     'warning': isStageExpiringSoon(stage),
                     'danger': isStageOverdue(stage)
                   }">
                <i class="bi" [ngClass]="{
                  'bi-exclamation-triangle': isStageExpiringSoon(stage),
                  'bi-exclamation-circle': isStageOverdue(stage),
                  'bi-calendar-check': !isStageExpiringSoon(stage) && !isStageOverdue(stage)
                }"></i>
                <span *ngIf="!isStageOverdue(stage)">{{ getDaysRemaining(stage) }} jours restants</span>
                <span *ngIf="isStageOverdue(stage)">Stage expiré</span>
              </div>
            </div>
          </div>

          <!-- Stage Actions -->
          <div class="stage-actions">
            <div class="action-group">
              <button 
                class="btn btn-outline-primary btn-sm"
                (click)="downloadConvention(stage.id)"
                [disabled]="!canDownloadDocuments(stage)"
                title="Télécharger la convention">
                <i class="bi bi-file-earmark-pdf"></i>
                <span>Convention</span>
              </button>
              
              <button 
                class="btn btn-outline-secondary btn-sm"
                (click)="downloadAssurance(stage.id)"
                [disabled]="!canDownloadDocuments(stage)"
                title="Télécharger l'attestation d'assurance">
                <i class="bi bi-shield-check"></i>
                <span>Assurance</span>
              </button>
              
              <button 
                class="btn btn-success btn-sm"
                (click)="uploadReport(stage.id)"
                [disabled]="!canSubmitReport(stage)"
                title="Soumettre votre rapport de stage">
                <i class="bi bi-cloud-upload"></i>
                <span>Rapport</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>